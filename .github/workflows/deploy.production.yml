name: Deploy Flybird Frontend Prod

on:
  push:
    branches:
      - prod  # adjust as needed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ⬇ Checkout code (just to satisfy GH Actions, not used directly)
      uses: actions/checkout@v4

    - name: 🚀 Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          set -e
          echo "🔑 Starting Flybird PHP deployment..."
          
          cd /var/www/prod/flybird/flybird-fe || { echo '❌ Directory not found'; exit 1; }

          echo "make a safe directory"
          git config --global --add safe.directory /var/www/prod/flybird/flybird-fe
          
          echo "📥 Pulling latest code..."
          git pull origin master
          
          echo "🧠 Using Node 18..."
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          nvm install 18
          nvm use 18
          
          echo "📦 Installing dependencies..."
          npm install --legacy-peer-deps
          
          echo "🏗️ Building app..."
          npm run build
          
          
          echo "🔁 Restarting NGINX..."
          sudo systemctl reload nginx
          
          echo "✅ Flybird deployment completed successfully!"
